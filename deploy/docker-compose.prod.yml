services:
  vault:
    image: hashicorp/vault:${VAULT_VERSION:-1.21}
    container_name: ${VAULT_CONTAINER_NAME:-vault-crypto-prod}
    restart: unless-stopped
    ports:
      - "${VAULT_PORT:-8200}:8200"
      - "${VAULT_CLUSTER_PORT:-8201}:8201"
    environment:
      VAULT_ADDR: "https://127.0.0.1:8200"
      VAULT_CACERT: "/vault/tls/ca.pem"
      # AWS KMS credentials (only needed for awskms unseal method)
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID:-}"
      AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY:-}"
      AWS_REGION: "${AWS_REGION:-}"
    cap_add:
      - IPC_LOCK
    volumes:
      # Persistent data storage (Raft + WAL)
      - ./data:/vault/data
      # Vault HCL configuration (entrypoint needs chown for vault user)
      - ./config:/vault/config
      # TLS certificates
      - ./tls:/vault/tls
      # Plugin binaries (read-only)
      - ../build:/vault/plugins:ro
      # Audit logs
      - ./logs:/vault/logs
    # Chown bind-mounted dirs (data, tls) that the default entrypoint does not handle,
    # then delegate to the original entrypoint which chowns config/logs and drops to vault user.
    entrypoint: ["/bin/sh", "-c"]
    command:
      - chown -R vault:vault /vault/data /vault/tls && exec docker-entrypoint.sh vault server -config=/vault/config/vault.hcl
    healthcheck:
      test: ["CMD-SHELL", "vault status -tls-skip-verify 2>&1 || [ $$? -eq 2 ]"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
